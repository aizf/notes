#

<https://github.com/dwqs/blog/issues/68>

## 1 CSRF（Cross-site request forgery）：跨站请求伪造

原理：转发Cookie(如果该cookie没有过期，即使页面关闭)。不同页面请求同一连接(path内)，会自动携带cookie

每个 Cookie 都会有与之关联的域，这个域的范围一般通过 donmain 属性指定。

如果 Cookie 的域和页面的域相同，那么我们称这个 Cookie 为第一方 Cookie（first-party cookie），如果 Cookie 的域和页面的域不同，则称之为第三方 Cookie（third-party cookie）。

### 1.1 如何防御

#### 方法一：Token 验证：（用的最多）

（1）服务器发送给客户端一个token；

（2）客户端提交的表单中带着这个token。

（3）如果这个 token 不合法，那么服务器拒绝这个请求。

#### 方法二：使用验证码

只要是涉及到数据交互就先进行验证码验证，这个方法可以完全解决CSRF。

#### 方法三：Referer 验证(SameSite属性)

Referer 指的是页面请求来源。意思是，只接受本站的请求，服务器才做响应；如果不是，就拦截

## 2 XSS（Cross Site Scripting）：跨域脚本攻击

XSS攻击可以分为3类：反射型（非持久型）、存储型（持久型）、基于DOM。

### 2.1 XSS的攻击原理

不需要你做任何的登录认证，它会通过合法的操作（比如在url中输入、在评论框中输入），向你的页面**注入脚本**（可能是js、hmtl代码块等）。

最后导致的结果可能是：

盗用Cookie破坏页面的正常结构，插入广告等恶意内容D-doss攻击

### 2.2 XSS的攻击方式

#### 2.2.1 反射型（非持久型）

发出请求时，**XSS代码出现在url中，作为输入提交到服务器端，服务器端解析后响应，XSS代码随响应内容一起传回给浏览器，最后浏览器解析执行XSS代码**。这个过程像一次反射，所以叫反射型XSS。

这种攻击方式往往需要攻击者诱使用户点击一个恶意链接，或者提交一个表单，或者进入一个恶意网站时，注入脚本进入被攻击者的网站。

#### 2.2.2 存储型（持久型）

储型XSS和反射型XSS的差别在于，提交的代码**会存储在服务器端**（数据库、内存、文件系统等），下次请求时目标页面时不用再提交XSS代码。

**比较常见的一个场景**是攻击者在社区或论坛上写下一篇包含恶意 JavaScript 代码的文章或评论，文章或评论发表后，所有访问该文章或评论的用户，都会在他们的浏览器中执行这段恶意的 JavaScript 代码。

XSS的防范措施（encode + 过滤）

#### 2.2.3 基于DOM

通过恶意脚本修改页面的 DOM 结构，是纯粹发生在客户端的攻击

### 2.3 XSS的防范措施主要有三个

现在主流的浏览器内置了防范 XSS 的措施，例如 CSP。

1、对敏感字符做转义(输入，输出)

(1) HTML：对以下这些字符进行转义：

- `&：&amp;`
- `<：&alt;`
- `>：&gt;`
- `'：&#x27;`
- `"：&quot;`
- `/：&#x2F;`

(2) Javascript：把所有非字母、数字的字符都转义成小于256的ASCII字符；

(3)URL：使用Javascript的`encodeURIComponent()`方法对用户的输入进行编码，该方法会编码如下字符：`,      /      ?     :     @     &     =     +     $     #`

(4)利用模板引擎而不是拼接HTML

(5)自动扫描工具寻找潜在的 XSS 漏洞

2、CSP

本质上是建立白名单，规定了浏览器只能够执行特定来源的代码，在网站的http头部定义了 `Content-Security-Policy`

3、Http响应头设置HttpOnly

cookie中设置了HttpOnly属性，那么通过js脚本将无法读取到cookie信息
