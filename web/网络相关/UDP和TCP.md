# UDP和TCP

<https://zhuanlan.zhihu.com/p/108822858?utm_source=wechat_session&utm_medium=social&utm_oi=760863794850197504>

<https://mp.weixin.qq.com/s?__biz=MzA4Nzg0MDM5Nw==&mid=2247484896&idx=1&sn=f7a351ffd19f14f8afdccb77557ca306&chksm=90320602a7458f144124f76cc78a9fd87d20c2c51e7c756fb6eccc1672116c6c3ef4bfc9098d&scene=0&xtrack=1#rd>

网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。

传输层提供了进程间的逻辑通信，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。

## 1 UDP 和 TCP 的特点与区别

**用户数据报协议 UDP**（User Datagram Protocol）

是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。

**传输控制协议 TCP**（Transmission Control Protocol）

是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。

## 2 UDP 、TCP 首部格式

TCP 的 6 种标识:

- SYN (建立联机)
- ACK (确认)
- PSH (传送)
- FIN (结束)
- RST (重置)
- URG (紧急)

## 3 TCP 的三次握手

![avatar](.\res\2.webp)

TCP 是一种面向连接的单播协议，在发送数据前，通信双方必须在彼此间建立一条连接。**所谓的“连接”，其实是客户端和服务器的内存里保存的一份关于对方的信息，如 IP 地址、端口号等**。

1. 第一次握手
   1. 客户端向服务器发出连接请求报文，这时报文首部中的同部位SYN=1，同时随机生成初始序列号 seq=x
   2. 此时，TCP客户端进程进入了 `SYN-SENT`（同步已发送状态）状态。
2. 第二次握手
   1. TCP服务器收到请求报文后，如果同意连接，则发出确认报文。确认报文中应该 ACK=1，SYN=1，确认号是ack=x+1，同时也要为自己随机初始化一个序列号 seq=y
   2. 此时，TCP服务器进程进入了`SYN-RCVD`（同步收到）状态。
   3. 如果拒绝
3. 第三次握手
   1. 客户进程收到确认后，还要向服务器给出确认。确认报文的ACK=1，ack=y+1，此时，TCP连接建立，客户端进入`ESTABLISHED`（已建立连接）状态。

## 4 为什么要三次握手

1. 已失效的连接请求报文段
   1. client发送了第一个连接的请求报文，但是由于网络不好，直到某个时间才到达server
   2. server端接收到这个请求报文后，还是会想client发出确认的报文，表示同意连接
   3. 假如不采用三次握手，那么只要server发出确认，新的建立就连接了，但其实这个请求是失效的请求，client是不会理睬server的确认信息
   4. 但是server认为新的连接已经建立起来了，并一直等待client发来数据，这样，server的很多资源就没白白浪费掉了

## 5 TCP数据的传输过程

建立连接后，两台主机就可以相互传输数据了。
